name: Deploy to Netlify (angular.az)

on:
  push:
    branches:
      - main
    paths:
      # Məzmun (md faylları) dəyişdikdə
      - 'adev/src/content/**'
      - 'adev/src/**/*.html'
      - 'adev/src/**/*.ts'
      - 'adev/src/**/*.scss'
      # Konfiq dəyişdikdə
      - 'adev/angular.json'
      - 'netlify.toml'
      - '.github/workflows/deploy.yml'

  # Manual olaraq da işlətmək üçün (GitHub-dan "Run workflow" düyməsi)
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout kodu al
        uses: actions/checkout@v4

      - name: Node.js qur
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: pnpm qur
        uses: pnpm/action-setup@v4
        with:
          version: '10.30.0'

      - name: Bazel cache (sürətli build üçün)
        uses: actions/cache@v4
        with:
          path: ~/.cache/bazel
          key: bazel-${{ runner.os }}-${{ hashFiles('.bazelversion', 'MODULE.bazel') }}
          restore-keys: |
            bazel-${{ runner.os }}-

      - name: Asılılıqları quraşdır
        run: pnpm install --frozen-lockfile

      - name: Layihəni build et
        run: pnpm bazel build //adev:build

      - name: public/ qovluğunu hazırla
        run: |
          mkdir -p public
          cp -rL dist/bin/adev/dist/browser/. public/
          cp public/index.csr.html public/index.html
          echo "/*    /index.html   200" > public/_redirects

      - name: Netlify-ya deploy et
        run: |
          npm install -g netlify-cli
          netlify deploy --dir=public --prod --no-build
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
